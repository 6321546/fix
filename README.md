# プログラミング試験
## 基本設計について
回答言語についてはPython3.8.3を使用しています。  
ライブラリとして  
re : 正規表現操作  
datetime : 基本的な日付型及び時間型  
ipaddress : IPv4/IPv6 操作ライブラリ  
を用いています。

どの回答のプログラムも1行づつログファイルからデータを読み込み、正規表現表現を用いて必要な情報を分割して得ています。
各回答ごとに故障期間を出力する関数ReportTime()と、アドレスaddres、故障開始時間のリストsTime、故障終了時間のリストeTime、自身故障中なのかどうかを表すstateをデータとして持つようなclass:Serverを定義しています。

主なプログラムの流れ.  
(1). class:Serverを要素として持つリスト内に該当アドレスを持つサーバーがあるかどうかを調べる。  
(2). なければ追加を行う。  
(3). (1)で見つけたサーバー、もしくは、(2)で追加したサーバーに対してping値に対応して処理を行う。  
(4). サーバーが故障状態なのかどうか判断し、クラスのリストに時間を記録する。  
(5). (1)-(4)をファイルが読み終わるまで行う。  
(6). 結果を表示。  

以下の回答の解説については前述したもの以外にclass:Serverが持っている値、(3)のpingの値に対応した処理、(4)のサーバーの故障状態の判断と時間の記録の仕方について述べる。
## Q1.
監視ログファイルを読み込み、故障状態のサーバアドレスとそのサーバの故障期間を出力するプログラムを作成せよ。
出力フォーマットは任意でよい。
なお、pingがタイムアウトした場合を故障とみなし、最初にタイムアウトしたときから、次にpingの応答が返るまでを故障期間とする。

### A1.
#### 前述したもの以外にclass:Serverが持っている値
count:タイムアウトの連続回数.
#### pingの値に対応した処理
'-'  : countの値を1にする:関数addcount(). 
other: countの値を0にする:関数resetcount(). 
#### サーバーの故障状態の判断と時間の記録の仕方:関数isBreak(time)
countの値が1でstateがFalseなら開始時間のリストsTimeに時間を追加する。その後stateをTrueにする。  
countの値が0でstateがTrueなら終了時間のリストeTimeに時間を記録する。その後stateをFalseにする。  
上記以外の条件では何もしない。
## Q2.
ネットワークの状態によっては、一時的にpingがタイムアウトしても、一定期間するとpingの応答が復活することがあり、そのような場合はサーバの故障とみなさないようにしたい。
N回以上連続してタイムアウトした場合にのみ故障とみなすように、設問1のプログラムを拡張せよ。
Nはプログラムのパラメータとして与えられるようにすること。

### A2.
#### 前述したもの以外にclass:Serverが持っている値
count:タイムアウトの連続回数. 
N:故障の閾値. 
#### pingの値に対応した処理
'-'  : countの値がN以下ならcountの値を1増加させる:関数addcount(). 
other: countの値を0にする:関数resetcount(). 
#### サーバーの故障状態の判断と時間の記録の仕方:関数isBreak(time)
countの値がNでstateがFalseなら開始時間のリストsTimeに時間を追加する。その後stateをTrueにする。  
countの値が0でstateがTrueなら終了時間のリストeTimeに時間を記録する。その後stateをFalseにする。  
上記以外の条件では何もしない。
## Q3.
サーバが返すpingの応答時間が長くなる場合、サーバが過負荷状態になっていると考えられる。
そこで、直近m回の平均応答時間がtミリ秒を超えた場合は、サーバが過負荷状態になっているとみなそう。
設問2のプログラムを拡張して、各サーバの過負荷状態となっている期間を出力できるようにせよ。mとtはプログラムのパラメータとして与えられるようにすること。

### A3.
#### 特記事項:タイムアウトの扱いについて
タイムアウトした場合は応答受付時間内に返答がないので、これも過負荷状態によるものと考え、ping値を40000として与え計算を行っている。このping値についてはwindowsコマンドのpingコマンドのデフォルトタイムアウト値を参考としています。
#### 特記事項:平均応答時間の計算について
直近の応答がM回より小さい場合は、その数で平均をとり平均応答時間を計算しています。
#### 前述したもの以外にclass:Serverが持っている値
M:計算する直近の回数. 
T:平均応答時間の閾値. 
PingMemory:直近M回のping値を要素として持つリスト. 
index:PingMemoryのインデックス. 
#### pingの値に対応した処理:関数addping(ping)
PingMemoryの中で一番古いping値が格納されているインデックスへ新しいping値を格納する。
#### サーバーの故障状態の判断と時間の記録の仕方
平均応答時間がTを超えていてstateがFalseなら開始時間のリストsTimeに時間を追加する。その後stateをTrueにする。  
平均応答時間がT以下でstateがTrueなら終了時間のリストeTimeに時間を記録する。その後stateをTrueにする。  
上記以外の条件では何もしない。
## Q4.
ネットワーク経路にあるスイッチに障害が発生した場合、そのスイッチの配下にあるサーバの応答がすべてタイムアウトすると想定される。
そこで、あるサブネット内のサーバが全て故障（ping応答がすべてN回以上連続でタイムアウト）している場合は、
そのサブネット（のスイッチ）の故障とみなそう。
設問2または3のプログラムを拡張して、各サブネット毎にネットワークの故障期間を出力できるようにせよ。

### A4.
#### 特記事項:
この問題の回答プログラムのみ主な流れが少し異なる。また、class:Serverの他にclass:SubNetworkが定義されている。  
class:Subnetworkはclass:Serverと同様に故障期間を出力する関数ReportTime()と、ネットワークアドレスnetwork、故障開始時間のリストsTime、故障終了時間のリストeTime、自身故障中なのかどうかを表すstateを持っています。  
class:ServerについてはA2.と同じものです。

主なプログラムの流れ. 
(1). class:SubNetworkを要素として持つリスト内に該当ネットワークアドレスを持つネットワークがあるかどうかを調べる。  
(2). なければリストにネットワークの追加を行う。  
(3). (1)で見つけたネットワーク、もしくは、(2)で追加したネットワークが持つサーバーのリストに対して該当アドレスを持つサーバーがあるかを調べる。  
(4). なければ該当ネットワークが持つサーバーのリストに新しいサーバー(class:Server)の追加を行う。  
(5). (3)で見つけたサーバー、もしくは、(4)で追加したサーバーが故障状態なのかどうか判断し、サーバーのリストに時間を記録する。  
(6). 全てのサーバーが故障状態なのかどうか判断し、クラス(SubNetwork)のリストに時間を記録する。  
(7). (1)-(4)をファイルが読み終わるまで行う。  
(8). 結果を表示。  
#### 特記事項:表示される結果について
データを全て読み込んだ後に確認できる同一ネットワーク上の全てのサーバーが故障していた場合のみネットワ>ークが故障したとみなしています。  
具体的には、あるネットワークでは全てのデータ読み込んだあとサーバーが3つあったとする。この時正常な時間を'='で表し、故障している時間を'-'で表し、サーバーが確認できていない時間を' 'で表たとき、以下のようになっていたとする、  
s1:===-------=======-----------=============--------  
s2:              =======----------===========-------  
s3:                                  =====----------  
t :   [--1--]           [--2--]              [--3--]. 
この場合、ネットワークの故障とみなす期間は3つのサーバー全ての故障が確認できる[3]の期間だけである。
####前述したもの以外にclass:Subnetworkが持っている値
severs: class:Serverのリスト
####pingの値に対応した処理
該当Subnetworkのもつサーバーのリストに対してA2.と同じ処理を行なっている。
####ネットワークの故障状態の判断と時間の記録の仕方
サーバーのリストが持つサーバーの状態(class:Serverのstate)が全て故障していて、stateがFalseなら開始時間のリストsTimeに時間を追加する。その後stateをTrueにする。  
サーバーのリストが持つサーバーの状態(class:Serverのstate)が1つ以上正常で、stateがTrueなら終了時間のリストeTimeに時間を記録する。その後stateをFalseにする。  
上記以外の条件では何もしない。
